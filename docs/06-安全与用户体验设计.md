# 🔐 精灵1号 - 安全与用户体验设计

> 安全可审计 + 傻瓜式使用

---

## 一、安全架构设计

### 1.1 安全原则

| 原则 | 说明 |
|------|------|
| **最小权限** | 精灵只获取完成任务所需的最小权限 |
| **用户可控** | 用户随时可以查看、撤销、终止 |
| **加密存储** | 所有敏感数据加密存储 |
| **传输加密** | 所有通信使用 HTTPS/TLS |
| **审计日志** | 所有操作可追溯 |
| **隔离存储** | 用户之间数据完全隔离 |

### 1.2 安全架构

```
┌─────────────────────────────────────────────────────────────┐
│                       用户终端                               │
│                    (飞书/Web控制台)                          │
└─────────────────────────┬───────────────────────────────────┘
                          │ HTTPS + Token 认证
                          ▼
┌─────────────────────────────────────────────────────────────┐
│                      API 网关层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  身份认证   │  │  权限校验   │  │  请求限流   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                      业务逻辑层                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  敏感操作   │  │  审计日志   │  │  异常检测   │         │
│  │  确认机制   │  │  记录       │  │             │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────▼───────────────────────────────────┐
│                      数据存储层                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   加密存储                           │   │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐             │   │
│  │  │ API Key │  │ Cookie  │  │ SSH Key │             │   │
│  │  │ (AES)   │  │ (AES)   │  │ (AES)   │             │   │
│  │  └─────────┘  └─────────┘  └─────────┘             │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  用户 A 数据 ←──隔离──→ 用户 B 数据                         │
└─────────────────────────────────────────────────────────────┘
```

### 1.3 敏感数据加密

```typescript
// 加密方案
const ENCRYPTION = {
  algorithm: 'AES-256-GCM',      // 加密算法
  keyDerivation: 'PBKDF2',       // 密钥派生
  iterations: 100000,            // 迭代次数
  saltLength: 16,                // 盐长度
  ivLength: 12,                  // IV 长度
  tagLength: 16,                 // 认证标签长度
};

// 加密流程
用户主密码 → PBKDF2 派生 → AES-256 密钥 → 加密数据
                                            │
                                            ▼
                                    存储到数据库
                                  (只存加密后的数据)
```

### 1.4 安全审计日志

```typescript
// 所有操作都记录审计日志
interface AuditLog {
  id: string;
  userId: string;
  timestamp: Date;
  action: string;           // 操作类型
  resource: string;         // 操作资源
  detail: object;           // 操作详情
  ip: string;               // 来源 IP
  userAgent: string;        // 客户端信息
  result: 'success' | 'failed' | 'denied';
}

// 审计的操作类型
- 登录/登出
- 添加/删除授权
- 创建/删除 Agent
- 执行敏感操作
- 访问敏感数据
- 配置变更
```

### 1.5 安全审计清单

| 检查项 | 说明 | 状态 |
|--------|------|------|
| 身份认证 | 飞书 OAuth / Token 认证 | 需实现 |
| 权限控制 | 用户只能访问自己的数据 | 需实现 |
| 数据加密 | AES-256-GCM 加密存储 | 需实现 |
| 传输加密 | HTTPS/TLS 1.3 | 需实现 |
| 敏感操作确认 | 飞书卡片确认 | ✅ 已设计 |
| 审计日志 | 完整操作记录 | 需实现 |
| 请求限流 | 防止滥用 | 需实现 |
| 输入验证 | 防止注入攻击 | 需实现 |
| 错误处理 | 不泄露敏感信息 | 需实现 |

---

## 二、用户 API Key 管理

### 2.1 支持的 API 配置

用户可以配置：

| 类型 | 示例 | 说明 |
|------|------|------|
| **中转站** | OpenRouter、SiliconFlow | 一个 Key 访问多个模型 |
| **直连模型** | OpenAI、Claude、Gemini | 单独的模型 Key |
| **本地模型** | Ollama | 本地运行，无需 Key |

### 2.2 傻瓜式配置界面

```
┌─────────────────────────────────────────────────────────────┐
│  🔑 AI 模型配置                                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  推荐方式：使用中转站（一个 Key 用所有模型）                  │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  🌟 硅基流动 (SiliconFlow)              [推荐]       │   │
│  │                                                     │   │
│  │  API Key: [________________________] [👁️]          │   │
│  │                                                     │   │
│  │  支持模型：GPT-4、Claude、Qwen、DeepSeek...         │   │
│  │                                                     │   │
│  │  [获取 Key →]  [测试连接]  [保存]                   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ─────────────── 或者单独配置 ───────────────              │
│                                                             │
│  ▶ OpenAI (GPT-4)                          [未配置]        │
│  ▶ Anthropic (Claude)                      [未配置]        │
│  ▶ Google (Gemini)                         [未配置]        │
│  ▶ 本地模型 (Ollama)                       [未配置]        │
│                                                             │
│  💡 小贴士：推荐使用硅基流动，一个 Key 就能用所有模型！      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 一键配置流程

```
用户在飞书说："精灵，我想配置 AI 模型"

精灵1号：
┌─────────────────────────────────────────┐
│  🔑 配置 AI 模型                        │
│                                         │
│  推荐使用「硅基流动」                   │
│  一个 Key 就能用所有主流模型！          │
│                                         │
│  [🌟 配置硅基流动]                      │
│  [📝 我有其他 API Key]                  │
│  [❓ 什么是 API Key]                    │
└─────────────────────────────────────────┘

用户点击「配置硅基流动」→ 跳转 Web 页面 → 输入 Key → 完成
```

---

## 三、AI Agent 存储设计

### 3.1 Agent 数据结构

```typescript
interface AIAgent {
  id: string;
  userId: string;           // 所属用户
  name: string;             // Agent 名称
  description: string;      // 描述
  
  // Agent 定义
  definition: {
    systemPrompt: string;   // 系统提示词
    capabilities: string[]; // 能力列表
    tools: string[];        // 可用工具
    model?: string;         // 指定模型（可选）
    constraints?: string[]; // 约束条件
  };
  
  // 元数据
  createdAt: Date;
  updatedAt: Date;
  lastUsedAt?: Date;
  usageCount: number;       // 使用次数
  
  // 状态
  status: 'active' | 'archived' | 'deleted';
  isPublic: boolean;        // 是否公开（未来：Agent 市场）
}
```

### 3.2 Agent 自动保存

精灵创建的 Agent 自动保存，用户不需要手动操作：

```
用户: "精灵，帮我创建一个专门写小红书文案的助手"

精灵1号:
├─ 理解需求
├─ 创建 Agent 定义
├─ 自动保存到数据库 ✅
└─ 返回结果

精灵: "已创建「小红书文案助手」！
      
      它可以：
      - 分析热门文案风格
      - 生成吸引人的标题
      - 撰写种草文案
      
      下次直接说「用小红书助手帮我...」就可以了！"
```

### 3.3 Agent 管理界面

```
┌─────────────────────────────────────────────────────────────┐
│  🤖 我的 Agent                                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  📝 小红书文案助手                      使用 23 次   │   │
│  │  专门写小红书种草文案的助手                         │   │
│  │  [使用] [编辑] [删除]                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  🔍 竞品分析师                          使用 8 次    │   │
│  │  分析竞品并生成报告                                 │   │
│  │  [使用] [编辑] [删除]                               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  [+ 创建新 Agent]                                          │
│                                                             │
│  💡 小贴士：直接对精灵说需求，它会自动创建合适的 Agent     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 四、傻瓜式用户体验

### 4.1 设计原则

| 原则 | 说明 |
|------|------|
| **零学习成本** | 用自然语言，像和人说话一样 |
| **引导式操作** | 不知道怎么做？精灵会引导 |
| **一键完成** | 复杂操作简化为一键 |
| **智能默认** | 合理的默认值，减少配置 |
| **即时反馈** | 每一步都有清晰的反馈 |

### 4.2 首次使用引导

```
用户第一次和精灵对话：

精灵: "你好！我是精灵1号 🧚
      
      我可以帮你：
      • 操作任何网站（登录、下单、发帖...）
      • 管理服务器（查状态、修bug...）
      • 创建专属 AI 助手
      • 任何你能想到的事！
      
      在开始之前，需要简单设置一下：
      
      [🔑 配置 AI 模型] ← 必须
      [🌐 登录常用网站] ← 可选
      [🖥️ 添加服务器] ← 可选
      
      或者直接告诉我你想做什么，我会引导你！"
```

### 4.3 智能引导

```
用户: "帮我在小红书发个帖子"

精灵: "好的！不过我还没有登录你的小红书账号。
      
      [🔐 立即登录小红书]
      
      点击后我会打开浏览器，你登录一下就好，
      之后就不用再登录了！"

用户点击 → 完成登录 → 精灵继续执行
```

### 4.4 简化的交互模式

**复杂操作 → 简单对话**

```
传统方式：
1. 打开控制台
2. 找到 Agent 管理
3. 点击创建
4. 填写表单（名称、描述、提示词、工具...）
5. 保存
6. 使用

精灵1号方式：
用户: "帮我弄个写周报的助手"
精灵: "好的！「周报助手」已创建 ✅"
```

**多步任务 → 一句话**

```
传统方式：
1. 打开 12306
2. 登录
3. 选择日期
4. 选择车次
5. 填写乘客
6. 提交订单
7. 支付

精灵1号方式：
用户: "帮我买明天北京到上海的高铁票"
精灵: 自动执行 → 需要确认时才打扰用户
```

### 4.5 交互卡片设计

**简洁、清晰、一目了然：**

```
┌─────────────────────────────────────┐
│  ✅ 任务完成                        │
│                                     │
│  已买到：G1234 北京→上海            │
│  时间：明天 08:00                   │
│  座位：二等座 5车 12A               │
│  价格：¥553                         │
│                                     │
│  [查看订单]                         │
└─────────────────────────────────────┘
```

**不要：**
```
❌ 大段文字说明
❌ 复杂的表单
❌ 技术术语
❌ 需要用户思考的选项
```

---

## 五、安全 vs 易用的平衡

### 5.1 分级确认机制

| 风险等级 | 操作示例 | 确认方式 |
|---------|---------|---------|
| 🟢 无风险 | 查询、浏览 | 静默执行 |
| 🟡 低风险 | 发消息、生成内容 | 执行后通知 |
| 🟠 中风险 | 登录、修改文件 | 飞书卡片确认 |
| 🔴 高风险 | 支付、删除、SSH | 飞书 + 指纹/二次确认 |

### 5.2 智能判断

精灵会智能判断风险等级：

```
用户: "帮我看看服务器状态"
精灵: (判断：只读操作，低风险)
      → 直接执行，返回结果

用户: "帮我重启 Nginx"
精灵: (判断：系统操作，中风险)
      → 发送确认卡片

用户: "帮我删除 /var/log 下的日志"
精灵: (判断：删除操作，高风险)
      → 详细列出将删除的内容
      → 要求二次确认
```

### 5.3 用户可配置

```
┌─────────────────────────────────────────────────────────────┐
│  ⚙️ 安全设置                                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  确认级别：                                                 │
│  ○ 谨慎模式 - 大多数操作都需确认（推荐新用户）              │
│  ● 标准模式 - 只有敏感操作需确认（推荐）                    │
│  ○ 信任模式 - 只有高危操作需确认（高级用户）                │
│                                                             │
│  ────────────────────────────────────────────────────       │
│                                                             │
│  特殊设置：                                                 │
│  ☑️ 支付操作始终需要确认                                    │
│  ☑️ 删除操作始终需要确认                                    │
│  ☑️ 服务器操作始终需要确认                                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 六、总结

### 安全审计准备

| 方面 | 措施 |
|------|------|
| 数据安全 | AES-256 加密、用户隔离 |
| 传输安全 | HTTPS/TLS |
| 访问控制 | OAuth 认证、权限校验 |
| 操作审计 | 完整日志记录 |
| 敏感操作 | 分级确认机制 |

### 用户体验保障

| 方面 | 措施 |
|------|------|
| 零门槛 | 自然语言交互 |
| 简单配置 | 引导式、一键操作 |
| 智能默认 | 减少用户选择 |
| 即时反馈 | 清晰的状态展示 |

**安全和易用不是对立的，而是可以兼得的！**

---

*下一步：实现这些设计*
