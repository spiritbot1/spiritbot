# 精灵1号 v0.3.0 - Docker 联合编排
# Spirit One Gateway + Core + Moltbot

version: '3.8'

services:
  # ========================
  # 精灵1号 Gateway - 统一入口
  # ========================
  spirit-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: spirit-one-gateway
    ports:
      - "3100:3100"
    environment:
      - NODE_ENV=production
      - GATEWAY_PORT=3100
      # 飞书配置
      - FEISHU_APP_ID=${FEISHU_APP_ID}
      - FEISHU_APP_SECRET=${FEISHU_APP_SECRET}
      - FEISHU_VERIFICATION_TOKEN=${FEISHU_VERIFICATION_TOKEN}
      - FEISHU_ENCRYPT_KEY=${FEISHU_ENCRYPT_KEY}
      # AI 配置
      - SILICONFLOW_API_KEY=${SILICONFLOW_API_KEY}
      - DEEPSEEK_API_KEY=${DEEPSEEK_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # Moltbot 连接
      - MOLTBOT_GATEWAY_URL=http://moltbot-gateway:18789
      - MOLTBOT_HOOK_TOKEN=${MOLTBOT_HOOK_TOKEN}
    volumes:
      - ./logs:/app/logs
    depends_on:
      - moltbot-gateway
    networks:
      - spirit-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ========================
  # Moltbot Gateway - 执行引擎
  # ========================
  moltbot-gateway:
    image: node:20-alpine
    container_name: spirit-moltbot
    working_dir: /app
    command: node libs/moltbot/moltbot.mjs gateway
    ports:
      - "18789:18789"
    environment:
      - NODE_ENV=production
      - GATEWAY_PORT=18789
      - GATEWAY_BIND=0.0.0.0
      # API Keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - SILICONFLOW_API_KEY=${SILICONFLOW_API_KEY}
    volumes:
      - ./libs/moltbot:/app/libs/moltbot:ro
      - ./soul-bridge:/app/soul-bridge:ro
      - moltbot-data:/root/.moltbot
    networks:
      - spirit-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ========================
  # 精灵1号 Core - 智能大脑
  # ========================
  spirit-core:
    build:
      context: ./core
      dockerfile: Dockerfile
    container_name: spirit-one-core
    ports:
      - "4000:4000"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - DATABASE_URL=postgres://postgres:postgres@postgres:5432/spirit_one
      - REDIS_URL=redis://redis:6379
      - SILICONFLOW_API_KEY=${SILICONFLOW_API_KEY}
    volumes:
      - core-data:/app/data
    depends_on:
      - postgres
      - redis
    networks:
      - spirit-network
    restart: unless-stopped

  # ========================
  # 知识图谱数据库
  # ========================
  postgres:
    image: postgres:16-alpine
    container_name: spirit-one-db
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=spirit_one
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - spirit-network
    restart: unless-stopped

  # ========================
  # 缓存和记忆
  # ========================
  redis:
    image: redis:7-alpine
    container_name: spirit-one-cache
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - spirit-network
    restart: unless-stopped

  # ========================
  # 向量数据库 (用于知识检索)
  # ========================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: spirit-one-vectors
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - spirit-network
    restart: unless-stopped

networks:
  spirit-network:
    driver: bridge

volumes:
  core-data:
  moltbot-data:
  postgres-data:
  redis-data:
  qdrant-data:

